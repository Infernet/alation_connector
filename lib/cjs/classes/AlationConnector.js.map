{"version":3,"sources":["../../../src/classes/AlationConnector.ts"],"names":["AlationConnector","constructor","user","alationURL","options","defaultOptions","tokenStoragePath","path","resolve","process","cwd","jobInterval","tokenName","accessTokenPath","refreshTokenPath","charAt","length","slice","apiClient","axios","create","baseURL","interceptors","request","use","config","headers","Token","getAccessToken","api_access_token","response","error","status","HTTP_STATUS","FORBIDDEN","regenerateAccessToken","JSON","parse","encoding","console","message","getRefreshToken","createOrUpdateRefreshToken","refreshToken","validateToken","data","post","refresh_token","user_id","saveToken","oldToken","name","token","token_status","TokenStatusEnum","ACTIVE","accessToken","stringify"],"mappings":"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","sourcesContent":["import {existsSync, readFileSync, unlinkSync, outputFileSync} from 'fs-extra';\nimport {\n  createAccessTokenRoute,\n  createRefreshTokenRoute,\n  HTTP_STATUS,\n  regenerateRefreshTokenRoute,\n  validateAccessTokenRoute,\n  validateRefreshTokenRoute,\n} from '../constants';\nimport axios, {AxiosError, AxiosInstance, AxiosRequestConfig} from 'axios';\nimport {IAccessToken, IConnectorAuthConfig, IRefreshToken} from '../interfaces';\nimport {TokenStatusEnum} from '../types';\nimport path from 'path';\n\nexport type IConnectorOptions = Partial<IConnectorConfig>;\n\nexport abstract class AlationConnector {\n  protected apiClient: AxiosInstance;\n  protected options: IConnectorConfig;\n\n  private readonly user: IConnectorAuthConfig;\n  private readonly alationURL: string;\n  private readonly accessTokenPath:string;\n  private readonly refreshTokenPath:string;\n\n  protected constructor(user: IConnectorAuthConfig, alationURL: string, options?: IConnectorOptions) {\n    this.user = user;\n    const defaultOptions: IConnectorConfig = {\n      tokenStoragePath: path.resolve(process.cwd(), 'keys/alation/'),\n      jobInterval: 1000,\n      tokenName: 'connector_token',\n    };\n    this.options = {...defaultOptions, ...options};\n\n    this.accessTokenPath = path.resolve(this.options.tokenStoragePath, `${this.options.tokenName}_access.token.json`);\n    this.refreshTokenPath = path.resolve(this.options.tokenStoragePath, `${this.options.tokenName}_refresh.token.json`);\n\n    this.alationURL = alationURL.charAt(alationURL.length - 1) === '/' ? alationURL.slice(0, alationURL.length - 1) : alationURL;\n    this.apiClient = axios.create({baseURL: this.alationURL});\n    // Привязка токена\n    this.apiClient.interceptors.request.use(async (config: AxiosRequestConfig) => {\n      config.headers.Token = (await this.getAccessToken()).api_access_token;\n      return config;\n    });\n    // Обработка ошибки сгорания токена\n    this.apiClient.interceptors.response.use((response) => response, async (error: AxiosError) => {\n      if (!error.response || error.response.status !== HTTP_STATUS.FORBIDDEN) {\n        return error;\n      }\n      const {config} = error.response;\n      config.headers.Token = (await this.regenerateAccessToken()).api_access_token;\n      return axios(config);\n    });\n  }\n\n  private async getAccessToken(): Promise<IAccessToken> {\n    try {\n      if (existsSync(this.accessTokenPath)) {\n        return JSON.parse(readFileSync(this.accessTokenPath, {encoding: 'utf-8'}));\n      }\n      return this.regenerateAccessToken();\n    } catch (error) {\n      console.error('CODE00000200 cant load or write alation access token key');\n      console.error(error.message);\n      throw error;\n    }\n  }\n\n  private async getRefreshToken(): Promise<IRefreshToken> {\n    try {\n      if (existsSync(this.refreshTokenPath)) {\n        return JSON.parse(readFileSync(this.refreshTokenPath, {encoding: 'utf-8'}));\n      } else {\n        return this.createOrUpdateRefreshToken();\n      }\n    } catch (error) {\n      console.error('CODE00000201 cant load or write alation refresh token key');\n      console.error(error.message);\n      throw error;\n    }\n  }\n\n  private async regenerateAccessToken(): Promise<IAccessToken> {\n    let refreshToken = await this.getRefreshToken();\n    if (!(await this.validateToken(refreshToken))) {\n      refreshToken = await this.createOrUpdateRefreshToken(refreshToken);\n    }\n    const {data} = await axios.post<IAccessToken>(createAccessTokenRoute(this.alationURL), {\n      refresh_token: refreshToken.refresh_token,\n      user_id: refreshToken.user_id,\n    });\n    this.saveToken(data);\n    return data;\n  }\n\n  private async createOrUpdateRefreshToken(oldToken?: IRefreshToken): Promise<IRefreshToken> {\n    try {\n      if (oldToken) {\n        const {data} = await axios.post<IRefreshToken>(regenerateRefreshTokenRoute(this.alationURL), {\n          refresh_token: oldToken.refresh_token,\n          user_id: oldToken.user_id,\n        });\n        this.saveToken(data);\n        return data;\n      }\n      const {data} = await axios.post<IRefreshToken>(createRefreshTokenRoute(this.alationURL), {\n        ...this.user,\n        name: this.options.tokenName,\n      });\n      this.saveToken(data);\n      return data;\n    } catch (error) {\n      console.error(`CODE00000202 createRefreshToken() finish with error: ${error?.message}`);\n      throw error;\n    }\n  }\n\n  private async validateToken(token: IAccessToken | IRefreshToken): Promise<boolean> {\n    try {\n      if ((token as IRefreshToken)['refresh_token']) {\n        const refreshToken = token as IRefreshToken;\n        const {data} = await axios.post<IRefreshToken>(validateRefreshTokenRoute(this.alationURL),\n            {\n              refresh_token: refreshToken.refresh_token,\n              user_id: refreshToken.user_id,\n            });\n        return data.token_status === TokenStatusEnum.ACTIVE;\n      }\n      const accessToken = token as IAccessToken;\n      const {data} = await axios.post<IAccessToken>(validateAccessTokenRoute(this.alationURL),\n          {\n            api_access_token: accessToken.api_access_token,\n            user_id: accessToken.user_id,\n          });\n      return data.token_status === TokenStatusEnum.ACTIVE;\n    } catch (error) {\n      if (error.response) {\n        return false;\n      }\n      console.error('CODE00000203 cant valid token, maybe token was expired or deleted');\n      console.error(error.message);\n      throw error;\n    }\n  }\n\n  private saveToken(token: IAccessToken | IRefreshToken): void {\n    const path = ((token as IRefreshToken)['refresh_token']) ? this.refreshTokenPath : this.accessTokenPath;\n    if (existsSync(path)) unlinkSync(path);\n    outputFileSync(path, JSON.stringify(token), {encoding: 'utf-8'});\n  }\n}\n\ninterface IConnectorConfig {\n  jobInterval: number;\n  tokenName: string;\n  tokenStoragePath: string;\n}\n"],"file":"AlationConnector.js"}